name: AI Content Generator

on:
  workflow_dispatch:
  schedule:
    - cron: '0 12 * * 1'

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests

      - name: Cleanup old structure
        run: |
          echo "üßπ –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É..."
          rm -rf content/posts/posts/ 2>/dev/null || true
          rm -rf content/posts/projects/ 2>/dev/null || true

      - name: Create content directory
        run: mkdir -p content/posts

      - name: Generate article with AI test
        env:
          HF_API_KEY: ${{ secrets.HF_API_KEY }}
        run: |
          echo "=== –¢–ï–°–¢–ò–†–£–ï–ú API HUGGING FACE ==="
          echo "–î–ª–∏–Ω–∞ HF_API_KEY: ${#HF_API_KEY} —Å–∏–º–≤–æ–ª–æ–≤"
          
          if [ -z "$HF_API_KEY" ] || [ "$HF_API_KEY" == "" ]; then
            echo "‚ùå HF_API_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏–ª–∏ –ø—É—Å—Ç–æ–π!"
            CONTENT="–û—à–∏–±–∫–∞: API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –î–æ–±–∞–≤—å—Ç–µ HF_API_KEY –≤ Settings ‚Üí Secrets ‚Üí Actions"
          else
            echo "üîå –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API..."
            echo "–ò—Å–ø–æ–ª—å–∑—É–µ–º –º–æ–¥–µ–ª—å: microsoft/DialoGPT-large"
            
            # –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∫ —Ä–∞–±–æ—Ç–∞—é—â–µ–π –º–æ–¥–µ–ª–∏
            response=$(curl -s -X POST \
              -H "Authorization: Bearer $HF_API_KEY" \
              -H "Content-Type: application/json" \
              -d '{
                "inputs": "–ù–∞–ø–∏—à–∏ –æ–¥–∏–Ω –∞–±–∑–∞—Ü –æ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤–µ–±-—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è—Ö:",
                "parameters": {
                  "max_new_tokens": 150,
                  "temperature": 0.8,
                  "do_sample": true
                }
              }' \
              "https://api-inference.huggingface.co/models/microsoft/DialoGPT-large" 2>&1)
            
            echo "=== –û–¢–í–ï–¢ API ==="
            echo "$response"
            echo "=== –ö–û–ù–ï–¶ –û–¢–í–ï–¢–ê ==="
            
            if [[ "$response" == *"generated_text"* ]]; then
              echo "‚úÖ API –ø–æ–¥–∫–ª—é—á–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!"
              CONTENT=$(echo "$response" | python3 -c "import json, sys; data=json.load(sys.stdin); print(data[0]['generated_text'])" | head -5)
            elif [[ "$response" == *"error"* ]]; then
              echo "‚ö†Ô∏è –û—à–∏–±–∫–∞ API, –Ω–æ –∫–ª—é—á —Ä–∞–±–æ—Ç–∞–µ—Ç"
              CONTENT="API –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ. –ö–ª—é—á –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –Ω–æ –º–æ–¥–µ–ª—å –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç."
            else
              echo "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ API"
              CONTENT="–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ AI API. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π."
            fi
          fi
          
          echo "üìù –°–æ–∑–¥–∞–µ–º —Å—Ç–∞—Ç—å—é..."
          DATE=$(date +%Y-%m-%d)
          TIMESTAMP=$(date +%H-%M-%S)
          FILE="content/posts/${DATE}-${TIMESTAMP}-ai-article.md"
          
          # –°–æ–∑–¥–∞–µ–º —Å—Ç–∞—Ç—å—é
          echo "---" > "$FILE"
          echo "title: \"AI –°—Ç–∞—Ç—å—è –æ—Ç ${TIMESTAMP}\"" >> "$FILE"
          echo "date: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> "$FILE"
          echo "draft: false" >> "$FILE"
          echo "description: \"–°—Ç–∞—Ç—å—è —Å–æ–∑–¥–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å AI\"" >> "$FILE"
          echo "tags: [\"ai\", \"–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è\", \"—Ç–µ—Å—Ç\"]" >> "$FILE"
          echo "---" >> "$FILE"
          echo "" >> "$FILE"
          echo "# üöÄ AI –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞" >> "$FILE"
          echo "" >> "$FILE"
          echo "$CONTENT" >> "$FILE"
          echo "" >> "$FILE"
          echo "## üìä –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏" >> "$FILE"
          echo "" >> "$FILE"
          echo "- **–î–∞—Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:** $(date +"%Y-%m-%d %H:%M:%S")" >> "$FILE"
          echo "- **–ú–æ–¥–µ–ª—å:** Microsoft DialoGPT-large" >> "$FILE"
          echo "- **–°—Ç–∞—Ç—É—Å API:** $(if [[ "$response" == *"generated_text"* ]]; then echo '‚úÖ –£—Å–ø–µ—à–Ω–æ'; else echo '‚ö†Ô∏è –û—à–∏–±–∫–∞'; fi)" >> "$FILE"
          echo "- **–î–ª–∏–Ω–∞ –∫–ª—é—á–∞:** ${#HF_API_KEY} —Å–∏–º–≤–æ–ª–æ–≤" >> "$FILE"
          echo "" >> "$FILE"
          echo "> *–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ GitHub Actions + Hugging Face API*" >> "$FILE"
          
          echo "‚úÖ –§–∞–π–ª —Å–æ–∑–¥–∞–Ω: $FILE"
          echo "üìÑ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä:"
          head -20 "$FILE"

      - name: Commit changes
        run: |
          echo "=== –ö–û–ú–ú–ò–¢ –ò–ó–ú–ï–ù–ï–ù–ò–ô ==="
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          git add content/posts/
          git status
          
          if ! git diff --staged --quiet; then
            git commit -m "ü§ñ –¢–µ—Å—Ç AI-–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç $(date +%Y-%m-%d_%H-%M-%S)"
            git pull origin main --rebase
            git push origin main
            echo "‚úÖ –°—Ç–∞—Ç—å—è –¥–æ–±–∞–≤–ª–µ–Ω–∞!"
          else
            echo "‚ùå –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
            echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏ posts:"
            ls -la content/posts/
          fi

      - name: Final check
        run: |
          echo "=== –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê ==="
          echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ñ–∞–π–ª—ã:"
          find content/posts/ -name "*.md" -type f -exec ls -la {} \; | tail -5
          echo "–í—Å–µ–≥–æ —Å—Ç–∞—Ç–µ–π:"
          find content/posts/ -name "*.md" -type f | wc -l
