name: AI Content Generator

on:
  workflow_dispatch:
  schedule:
    - cron: '0 12 * * 1'

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests

      - name: Cleanup old structure
        run: |
          echo "üßπ –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É..."
          rm -rf content/posts/posts/ 2>/dev/null || true
          rm -rf content/posts/projects/ 2>/dev/null || true

      - name: Create content directory
        run: mkdir -p content/posts

      - name: Test API connection
        env:
          HF_API_KEY: ${{ secrets.HF_API_KEY }}
        run: |
          echo "=== –¢–ï–°–¢ –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø API ==="
          echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å API –∫–ª—é—á–∞..."
          
          # –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—Ä–æ—Å –∫ API –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–ª—é—á–∞
          response=$(curl -s -w "\n%{http_code}" \
            -H "Authorization: Bearer $HF_API_KEY" \
            "https://huggingface.co/api/whoami")
          
          status_code=$(echo "$response" | tail -1)
          body=$(echo "$response" | head -n -1)
          
          echo "Status Code: $status_code"
          echo "Response: $body"
          
          if [ "$status_code" -eq 200 ]; then
            echo "‚úÖ API –∫–ª—é—á –≤–∞–ª–∏–¥–µ–Ω!"
          else
            echo "‚ùå API –∫–ª—é—á –Ω–µ–≤–∞–ª–∏–¥–µ–Ω –∏–ª–∏ –æ—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞"
            echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ HF_API_KEY –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"
          fi

      - name: Generate article with AI test
        env:
          HF_API_KEY: ${{ secrets.HF_API_KEY }}
        run: |
          echo "=== –¢–ï–°–¢–ò–†–£–ï–ú –†–ê–ë–û–ß–ò–ï –ú–û–î–ï–õ–ò ==="
          
          if [ -z "$HF_API_KEY" ] || [ "$HF_API_KEY" == "" ]; then
            echo "‚ùå HF_API_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!"
            CONTENT="–û—à–∏–±–∫–∞: API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω."
          else
            echo "üîå –û–ø—Ä–∞—à–∏–≤–∞–µ–º –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —Ä–∞–±–æ—á–∏–µ –º–æ–¥–µ–ª–∏..."
            
            # –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —Ä–∞–±–æ—á–∏–µ –º–æ–¥–µ–ª–∏ –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
            MODELS=(
              "google/flan-t5-small"
              "facebook/bart-large-cnn"
              "microsoft/DialoGPT-small"
              "valhalla/t5-small-qa"
            )
            
            CONTENT=""
            SUCCESS_MODEL=""
            
            for model in "${MODELS[@]}"; do
              echo "---"
              echo "üîÑ –ü—Ä–æ–±—É–µ–º –º–æ–¥–µ–ª—å: $model"
              
              response=$(curl -s -X POST \
                -H "Authorization: Bearer $HF_API_KEY" \
                -H "Content-Type: application/json" \
                -d '{
                  "inputs": "–û–±—ä—è—Å–Ω–∏ —á—Ç–æ —Ç–∞–∫–æ–µ –≤–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞:",
                  "parameters": {
                    "max_new_tokens": 100,
                    "temperature": 0.7
                  }
                }' \
                "https://api-inference.huggingface.co/models/$model" 2>&1)
              
              echo "–û—Ç–≤–µ—Ç: ${response:0:200}..."
              
              if [[ "$response" == *"generated_text"* ]]; then
                echo "‚úÖ –£—Å–ø–µ—Ö! –ú–æ–¥–µ–ª—å $model —Ä–∞–±–æ—Ç–∞–µ—Ç!"
                CONTENT=$(echo "$response" | python3 -c "import json, sys; data=json.load(sys.stdin); print(data[0]['generated_text'])" | head -8)
                SUCCESS_MODEL="$model"
                break
              elif [[ "$response" == *"error"* ]]; then
                echo "‚ö†Ô∏è –û—à–∏–±–∫–∞ –º–æ–¥–µ–ª–∏: $response"
              else
                echo "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏"
              fi
              
              sleep 1
            done
            
            if [ -z "$CONTENT" ]; then
              echo "‚ùå –ù–∏ –æ–¥–Ω–∞ –º–æ–¥–µ–ª—å –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞"
              CONTENT="–ü—Ä–æ–≤–µ—Ä–∫–∞ API: –≤—Å–µ –º–æ–¥–µ–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –æ—à–∏–±–∫–∏. –í–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–æ–±–ª–µ–º–∞ —Å —Ñ–æ—Ä–º–∞—Ç–æ–º –∑–∞–ø—Ä–æ—Å–∞ –∏–ª–∏ API endpoint."
              SUCCESS_MODEL="error"
            fi
          fi
          
          echo "üìù –°–æ–∑–¥–∞–µ–º —Å—Ç–∞—Ç—å—é..."
          DATE=$(date +%Y-%m-%d)
          TIMESTAMP=$(date +%H-%M-%S)
          FILE="content/posts/${DATE}-${TIMESTAMP}-ai-article.md"
          
          # –°–æ–∑–¥–∞–µ–º —Å—Ç–∞—Ç—å—é
          echo "---" > "$FILE"
          echo "title: \"AI –°—Ç–∞—Ç—å—è –æ—Ç ${TIMESTAMP}\"" >> "$FILE"
          echo "date: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> "$FILE"
          echo "draft: false" >> "$FILE"
          echo "description: \"–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Hugging Face API\"" >> "$FILE"
          echo "tags: [\"ai\", \"—Ç–µ—Å—Ç\", \"api\"]" >> "$FILE"
          echo "---" >> "$FILE"
          echo "" >> "$FILE"
          echo "# üöÄ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ AI –ì–µ–Ω–µ—Ä–∞—Ü–∏–∏" >> "$FILE"
          echo "" >> "$FILE"
          echo "$CONTENT" >> "$FILE"
          echo "" >> "$FILE"
          echo "## üìä –î–µ—Ç–∞–ª–∏ —Ç–µ—Å—Ç–∞" >> "$FILE"
          echo "" >> "$FILE"
          echo "- **–î–∞—Ç–∞:** $(date +"%Y-%m-%d %H:%M:%S")" >> "$FILE"
          echo "- **–ú–æ–¥–µ–ª—å:** ${SUCCESS_MODEL:-none}" >> "$FILE"
          echo "- **–°—Ç–∞—Ç—É—Å:** $(if [ "$SUCCESS_MODEL" != "error" ]; then echo '‚úÖ –£—Å–ø–µ—à–Ω–æ'; else echo '‚ùå –û—à–∏–±–∫–∞'; fi)" >> "$FILE"
          echo "- **–î–ª–∏–Ω–∞ –∫–ª—é—á–∞:** ${#HF_API_KEY} —Å–∏–º–≤–æ–ª–æ–≤" >> "$FILE"
          echo "" >> "$FILE"
          echo "> *–¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ API*" >> "$FILE"
          
          echo "‚úÖ –§–∞–π–ª —Å–æ–∑–¥–∞–Ω: $FILE"

      - name: Commit changes
        run: |
          echo "=== –ö–û–ú–ú–ò–¢ –ò–ó–ú–ï–ù–ï–ù–ò–ô ==="
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          
          git add content/posts/
          git status
          
          if ! git diff --staged --quiet; then
            git commit -m "ü§ñ –¢–µ—Å—Ç API –æ—Ç $(date +%Y-%m-%d_%H-%M-%S)"
            git pull origin main --rebase
            git push origin main
            echo "‚úÖ –°—Ç–∞—Ç—å—è –¥–æ–±–∞–≤–ª–µ–Ω–∞!"
          else
            echo "‚ùå –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
            ls -la content/posts/
          fi

      - name: Final check
        run: |
          echo "=== –§–ò–ù–ê–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê ==="
          echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ñ–∞–π–ª—ã:"
          find content/posts/ -name "*.md" -type f -exec ls -la {} \; | tail -3
