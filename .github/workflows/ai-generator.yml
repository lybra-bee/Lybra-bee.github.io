name: AI Content Generator

on:
  workflow_dispatch:
  schedule:
    - cron: '0 12 * * 1'

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install requests

      - name: Create content directory
        run: mkdir -p content/posts

      - name: Generate with OpenRouter
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          echo "=== –ì–ï–ù–ï–†–ê–¶–ò–Ø –ß–ï–†–ï–ó OPENROUTER ==="
          
          # –ü—Ä–æ—Å—Ç—ã–µ —Ç–µ–º—ã
          TOPICS=(
            "–í–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∏ 2024"
            "Serverless –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞"
            "–ò–ò –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ"
          )
          
          SELECTED_TOPIC=${TOPICS[$RANDOM % ${#TOPICS[@]}]}
          echo "üìù –¢–µ–º–∞: $SELECTED_TOPIC"
          
          # –ü—Ä–æ—Å—Ç–æ–π API –∑–∞–ø—Ä–æ—Å
          response=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENROUTER_API_KEY" \
            -d '{
              "model": "google/palm-2-chat-bison-32k:free",
              "messages": [
                {
                  "role": "user", 
                  "content": "–ù–∞–ø–∏—à–∏ –æ–¥–∏–Ω –∞–±–∑–∞—Ü –æ '"$SELECTED_TOPIC"' –Ω–∞ —Ä—É—Å—Å–∫–æ–º."
                }
              ],
              "max_tokens": 200
            }' \
            "https://openrouter.ai/api/v1/chat/completions")
          
          if [[ "$response" == *"choices"* ]]; then
            CONTENT=$(echo "$response" | python3 -c "
import json, sys
data = json.load(sys.stdin)
print(data['choices'][0]['message']['content'])
")
            echo "‚úÖ –£—Å–ø–µ—à–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è"
          else
            echo "‚ùå –û—à–∏–±–∫–∞ API, –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback"
            CONTENT="–≠—Ç–æ —Å—Ç–∞—Ç—å—è –æ $SELECTED_TOPIC. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏."
          fi
          
          # –°–æ–∑–¥–∞–µ–º —Å—Ç–∞—Ç—å—é
          DATE=$(date +%Y-%m-%d)
          FILE="content/posts/${DATE}-ai-article.md"
          
          cat > "$FILE" << EOF
---
title: "$SELECTED_TOPIC"
date: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
draft: false
tags: ["–≤–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞"]
---

# $SELECTED_TOPIC

$CONTENT

> –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
EOF
          
          echo "‚úÖ –§–∞–π–ª —Å–æ–∑–¥–∞–Ω: $FILE"

      - name: Commit changes
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          git add content/posts/
          git commit -m "ü§ñ AI —Å—Ç–∞—Ç—å—è: $(date +"%d.%m.%Y")" || echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π"
          git push
