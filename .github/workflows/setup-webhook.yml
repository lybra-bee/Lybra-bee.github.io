name: Setup Telegram Webhook

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'api/telegram.js'
      - '.github/workflows/setup-webhook.yml'

jobs:
  setup-webhook:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Telegram Webhook
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        VERCEL_URL: ${{ secrets.VERCEL_URL }}  # –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç —Å–µ–∫—Ä–µ—Ç
      run: |
        echo "üîÑ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ–±—Ö—É–∫–∞ –¥–ª—è Telegram –±–æ—Ç–∞..."
        
        # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–µ–±—Ö—É–∫–∞
        response=$(curl -s -X POST \
          "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/setWebhook" \
          -H "Content-Type: application/json" \
          -d "{\"url\": \"$VERCEL_URL/api/telegram\", \"max_connections\": 100}")
        
        echo "üìã –û—Ç–≤–µ—Ç –æ—Ç Telegram API:"
        echo $response | jq .
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤–µ–±—Ö—É–∫–∞
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤–µ–±—Ö—É–∫–∞..."
        curl -s "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/getWebhookInfo" | jq .
